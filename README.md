# Приложение для анализа транзакций

## Описание проекта

Данный проект предназначен для обработки транзакций, которые находятся в Excel-файле. Приложение, 
генерирует JSON-данные для веб-страниц, формирует отчеты по тратам за последние три месяца, а также предоставляет 
сервис для поиска переводов физическим лицам

## Установка

Для установки проекта:
1. Клонируйте репозиторий: 
git clone https://github.com/InnaVeselkova/excel-transaction-analytics.git
2. Активируйте виртуальное окружение:
python -m venv venv
source venv/bin/activate   # для Linux/MacOS
venv\Scripts\activate    # для Windows
3. Установите необходимые зависимости:
pip install -r requirements.txt

## Использование

Основные функции для генерации JSON-ответов реализованы в отдельном модуле views.py.

Данные для анализа и вывода на веб-страницах — это данные с начала месяца, на который выпадает входящая дата, по входящую дату.
Валюты и акции для отображения на веб-страницах задаются в отдельном файле пользовательских настроек 
user_settings.json

В модуле utils реализованы функции для страницы "Главная":

read_excel_file(excel_path: str) -> List[Dict] 

Считывает Excel-файл по указанному пути и преобразует данные в список словарей, где каждый словарь — одна запись (строка) из файла. Возвращает список записей или None в случае ошибки.

get_greeting() -> str 

Возвращает строку приветствия, соответствующую текущему времени суток:

"Доброй ночи" с 00:00 до 05:59,
"Доброе утро" с 06:00 до 11:59,
"Добрый день" с 12:00 до 17:59,
"Добрый вечер" с 18:00 до 23:59. 

get_date_time(data_time: str, date_format: str = "%Y-%m-%d %H:%M:%S") -> List[str] 

Принимает дату и время в виде строки и формат даты. Возвращает период — список из двух строк, представляющих начало месяца даты и саму дату в формате "дд-мм-гггг чч:мм:сс". Используется для задания диапазона дат.

sorted_cards_info(data_list: List[Dict[str, Any]], time_period: List[str]) -> List[Dict] 

Фильтрует и обрабатывает список транзакций по карте за указанный диапазон дат. Для каждой подходящей операции собирает данные:
последние цифры карты,
сумму операции, рассчитанный кэшбек (1% от суммы операции). Возвращает список таких словарей. 

top_transactions(data_list: List[Dict[str, Any]]) -> List[Dict] 

Находит и возвращает 5 транзакций с наибольшей суммой из списка. Каждая транзакция описана словарём с датой, суммой, категорией и описанием.

get_currency(path: str) -> List[Dict] 

На основе настроек пользователя в JSON-файле по пути path получает актуальные курсы валют (конвертация в RUB) через API. Возвращает список словарей с названием валюты и курсом обмена.

get_stocks(path: str) -> List[Dict] 

Читает список акций пользователя из JSON-файла по пути path и запрашивает их текущие курсы через внешний API. Возвращает список словарей с названием акции и её ценой. 

В модуле services реализована функция def filter_personal_transfers(data_list: List[Dict]) -> str, которая фильтрует транзакции, относящиеся к переводам физлицам 

В модуле reports содержится функция, которая возвращает сумму затрат по заданной категории за последние три месяца
    от указанной даты (или текущей, если дата не указана). (def get_expense_report(transactions, category, date=None).
Для ее реализации создан также декоратор для функции-отчета, который записывает в файл результат, который возвращает функция, формирующая отчет. 

Для всех функций написаны тесты, содержащиеся в соответствующих модулях: 

В test_utils: 

Используются pytest, unittest.mock.patch для имитации внешних вызовов.
Тесты покрывают функции для чтения файлов, получения поздравлений, форматирования дат, сортировки транзакций и работы с API.
Есть тесты для проверок ошибок и крайних случаев. 

Тесты функции чтения Excel файла (read_excel_file) 

test_read_excel_file_success
Проверяет успешное чтение файла Excel и корректность возвращаемых данных.

test_read_excel_file_file_not_found
Проверяет обработку ситуации, когда указанный файл отсутствует. Ожидается возврат None.

test_read_excel_file_other_exception
Проверяет обработку неожиданных ошибок при чтении файла, например, при поврежденном или неподдерживаемом формате.

Тесты функции получения приветствия (get_greeting) 

test_get_greeting_morning
Проверяет возврат утреннего приветствия при времени суток с 05:00 до 11:59.

test_get_greeting_afternoon
Проверяет возврат дневного приветствия для времени с 12:00 до 16:59.

test_get_greeting_evening
Проверяет возврат вечернего приветствия для времени с 17:00 до 21:59.

test_get_greeting_night
Проверяет возврат ночного приветствия для времени с 22:00 до 04:59.

Тесты функции форматирования даты и времени (get_date_time) 

test_get_date_time_correct_format
Проверяет правильность форматирования даты и времени по переданному объекту datetime.

test_get_date_time_invalid_format
Проверяет обработку ошибок при некорректном входном формате данных.

Тесты сортировки для вывода 5-ти топ транзакций (sorted_cards_info, top_transactions) 

test_sorted_cards_info
Проверяет корректную сортировку транзакций по убыванию суммы.

test_top_transactions
Проверяет получение топ-N транзакций по сумме.

test_sorted_cards_info_empty и test_top_transactions_empty
Проверяют работу функций при отсутствии данных (пустой список).

Тесты работы с API и внешними ресурсами 

test_get_currency_success
Проверяет получение курса валют с API (например, USD в RUB). Использует имитацию ответа API.

test_get_currency_request_exception
Проверяет обработку ошибок при неудачном запросе к API валют.

test_get_stocks_success
Тестирует получение информации о акциях из файла настроек. Использует мок-файл с настройками.

test_get_stocks_file_not_found и test_get_stocks_empty_content
Проверяют сценарии ошибок при отсутствии файла или пустом содержимом. 

В test_reports: 

Тесты функции получения отчёта о расходах (get_expense_report)
test_get_expense_report_recent_category
Проверяет правильность формирования отчёта о расходах по конкретной категории за последние 3 месяца на заданную дату. В данном случае — анализируется категория 'Food' на дату 15 июля 2023, ожидаемый итог — сумма 125.

test_get_expense_report_no_data_for_category
Проверяет случай, когда по заданной категории не найдено расходов за указанный период. Ожидаемый результат — сообщение о нулевых расходах по данной категории.

Тесты функции подсчёта расходов по категории (spending_by_category)
test_spending_by_category_calculation
Тестирует внутреннюю функцию подсчёта расходов по выбранной категории в заданной дате. В качестве данных — тестовый набор транзакций, сумма должна совпадать с ожидаемой — 125.

``test_spending_by_category_without_date`
Проверяет работу функции без указания конкретной даты, что должно вычислять расход для текущей даты. Тест убеждается в том, что функция работает без ошибок и возвращает неотрицательную сумму. 

В test_services: 

Тест функционала фильтрации персональных переводов
test_filter_personal_transfers_parametrized
Этот параметризованный тест проверяет функцию filter_personal_transfers, которая фильтрует список транзакций и возвращает только те, которые относятся к персональным переводам (категория 'Переводы') и содержат в описании имена (например, "Иванов А.", "Петров В.").

Тестовые кейсы покрывают следующие сценарии:

Корректные транзакции с подходящими описаниями:
Входные данные содержат несколько транзакций категории 'Переводы' с описаниями, в которых упомянуты имена. Ожидается, что функция отфильтрует 2 записи и вернёт только подходящие.

Отсутствие подходящих транзакций:
Данные содержат транзакции с другими категориями или с описаниями, не соответствующими ожидаемому шаблону. Ожидается пустой результат.

Пустой список транзакций:
Проверяется корректное поведение при отсутствии данных — функция должна вернуть пустой список.

Транзакции с неподходящей категорией:
Проверяется, что транзакции с категорией, отличной от 'Переводы', не попадут в результат.

Неподходящие описания при правильной категории:
Транзакции с категорией 'Переводы', но описаниями, не содержащими имён, не должны попадать в выходной список.

Проверяется как количество отфильтрованных транзакций, так и содержимое полей описания в результирующем списке. При отсутствии подходящих записей тест ожидает пустой результат.
